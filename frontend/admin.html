<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>管理后台</title>
  <script src="./api-config.js"></script>
  <link rel="stylesheet" href="./styles.css">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    header { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    input, button, textarea { font-size: 14px; padding: 6px 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f7f7f7; }
    .row-actions { display: flex; gap: 6px; }
    .muted { color: #888; }
  </style>
  <script src="./api-config.js"></script>
  <script src="./small-popup.js"></script>
  <script src="./small-modal.js"></script>
  <script>
    // API helper: prefer FEELINGS_API_BASE when set. This is deterministic (builds full URL at call time)
    function apiUrl(path) {
      try {
        if (window && window.FEELINGS_API_BASE) return String(window.FEELINGS_API_BASE).replace(/\/$/, '') + path;
      } catch (e) {}
      return path;
    }

    let ADMIN_TOKEN = localStorage.getItem('ADMIN_TOKEN') || '';

    async function api(path, opts = {}) {
      const init = Object.assign({
        headers: { 'content-type': 'application/json', 'x-admin-token': ADMIN_TOKEN },
        credentials: 'omit',
      }, opts);
      const res = await fetch(apiUrl(path), init);
      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) throw new Error(data.error || res.statusText);
      return data.data;
    }

    let usersOffset = 0;
    const USERS_PAGE = 50;
    async function loadUsers() {
      const q = document.getElementById('q').value.trim();
      const params = new URLSearchParams();
      params.set('limit', String(USERS_PAGE));
      params.set('offset', String(usersOffset));
      if (q) params.set('q', q);
      const data = await api(`/api/admin/users?${params.toString()}`);
      const tbody = document.querySelector('#users tbody');
      tbody.innerHTML = '';
      for (const u of data.users) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.username}</td>
          <td class="muted">${u.hobby ?? ''}</td>
          <td>${u.sex ?? ''}</td>
          <td>${u.mood ?? ''}</td>
          <td>${u.last_mood_date ?? ''}</td>
          <td>${u.chatting ? '是' : '否'}</td>
          <td>${u.disabled ? '禁用' : '启用'}</td>
          <td class="row-actions"></td>
        `;
        const actions = tr.querySelector('.row-actions');
        const toggleBtn = document.createElement('button');
        toggleBtn.textContent = u.disabled ? '启用' : '禁用';
        toggleBtn.onclick = async () => {
          await api('/api/admin/set_disabled', { method: 'POST', body: JSON.stringify({ username: u.username, disabled: !u.disabled }) });
          await loadUsers();
        };
  const resetBtn = document.createElement('button');
        resetBtn.textContent = '重置密码';
        resetBtn.onclick = async () => {
          let pw = null;
          try {
            pw = await showModalPrompt('输入新的密码（会在本地转为SHA-256）', '');
          } catch (e) { pw = null; }
          if (!pw) return;
          const enc = new TextEncoder();
          const hashBuf = await crypto.subtle.digest('SHA-256', enc.encode(pw));
          const hex = [...new Uint8Array(hashBuf)].map(b => b.toString(16).padStart(2, '0')).join('');
          await api('/api/admin/reset_password', { method: 'POST', body: JSON.stringify({ username: u.username, new_password_sha: hex }) });
          try { if (window.showSmallPopup) window.showSmallPopup('已重置', { type: 'success', duration: 2500 }); else console.log('已重置'); } catch(e) { console.log('已重置'); }
        };
        const flagsWrap = document.createElement('span');
        const mkFlag = (key, label) => {
          const b = document.createElement('button');
          const on = !!u[key];
          b.textContent = `${label}:${on ? '禁' : '开'}`;
          b.onclick = async () => {
            const payload = { username: u.username };
            payload[key] = !on;
            await api('/api/admin/set_flags', { method: 'POST', body: JSON.stringify(payload) });
            await loadUsers();
          };
          return b;
        };
        flagsWrap.append(
          mkFlag('disable_anon_chat', '匿名'),
          mkFlag('disable_mood', '心情'),
          mkFlag('disable_ai', 'AI')
        );
        const forceBtn = document.createElement('button');
        forceBtn.textContent = '强制结束';
        forceBtn.onclick = async () => {
          try {
            let ok = false;
            ok = await showModalConfirm(`确定要强制结束 ${u.username} 的匿名会话吗？`);
            if (!ok) return;
            await api('/api/admin/force_end', { method: 'POST', body: JSON.stringify({ username: u.username }) });
            try { if (window.showSmallPopup) window.showSmallPopup('已强制结束', { type: 'success', duration: 2500 }); else console.log('已强制结束'); } catch(e) { console.log('已强制结束'); }
            await loadUsers();
            await loadVisits().catch(()=>{});
          } catch (err) { try { if (window.showSmallPopup) window.showSmallPopup(err.message || String(err), { type: 'error', duration: 3000 }); else console.log(err.message || String(err)); } catch(e) { console.log(err.message || String(err)); } }
        };
        actions.append(toggleBtn, resetBtn, flagsWrap);
        actions.append(forceBtn);
        tbody.appendChild(tr);
      }
      // users pager
      const up = document.getElementById('users-pager');
      if (up) {
        up.querySelector('#users-prev').disabled = usersOffset === 0;
        up.querySelector('#users-next').disabled = usersOffset + USERS_PAGE >= (data.total || 0);
        up.querySelector('#users-page').textContent = `${Math.floor(usersOffset/USERS_PAGE)+1} / ${Math.max(1, Math.ceil((data.total||0)/USERS_PAGE))}`;
      }
    }
    function usersPrev() { usersOffset = Math.max(0, usersOffset - USERS_PAGE); loadUsers(); }
    function usersNext() { usersOffset = usersOffset + USERS_PAGE; loadUsers(); }

    async function appendWords() {
      const txt = document.getElementById('words').value.trim();
  if (!txt) return (window.showSmallPopup ? window.showSmallPopup('请输入要追加的词，每行一个', { type: 'error', duration: 3000 }) : console.log('请输入要追加的词，每行一个'));
      const list = txt.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      await api('/api/admin/words_add', { method: 'POST', body: JSON.stringify({ words: list }) });
  try { if (window.showSmallPopup) window.showSmallPopup('已追加到词库临时区（bad_words_append）', { type: 'success', duration: 2500 }); else console.log('已追加到词库临时区（bad_words_append）'); } catch(e) { console.log('已追加到词库临时区（bad_words_append）'); }
      document.getElementById('words').value = '';
    }

    function saveToken() {
      ADMIN_TOKEN = document.getElementById('token').value.trim();
      localStorage.setItem('ADMIN_TOKEN', ADMIN_TOKEN);
  loadUsers().catch(err => { try { if (window.showSmallPopup) window.showSmallPopup(err.message || String(err), { type: 'error', duration: 3000 }); else console.log(err.message || String(err)); } catch(e) { console.log(err.message || String(err)); } });
  // refresh admin settings display
  fetchSettingsAdmin().catch(() => {});
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('token').value = ADMIN_TOKEN;
      if (ADMIN_TOKEN) {
        loadUsers().catch(() => {});
        loadVisits().catch(() => {});
        loadAnalytics().catch(() => {});
        fetchSettingsAdmin().catch(() => {});
        // load maintenance list for admin
        try { refreshAdminMaintenance().catch(()=>{}); } catch(e) {}
      }

        // --- Maintenance popup for admin view (also visible to admins) ---
        function showMaintPopupAdmin(items) {
          try {
            if (!items || !items.length) return;
            if (sessionStorage.getItem('maint_popup_dismissed')) return;
            const popup = document.getElementById('maint-popup');
            const body = document.getElementById('maint-popup-body');
            if (!popup || !body) return;
            const html = items.slice(0,3).map(m => `<h4 style="margin:0 0 6px 0;font-size:14px">${escapeHtml(m.title||'(无标题)')}</h4><p style="margin:0;font-size:13px;color:#333">${escapeHtml((m.details||'').slice(0,200))}</p>`).join('<hr>');
            body.innerHTML = html;
            popup.style.display = 'block';
            popup.querySelector('.close').addEventListener('click', () => { popup.style.display = 'none'; sessionStorage.setItem('maint_popup_dismissed', '1'); });
          } catch (e) { console.error('showMaintPopupAdmin', e); }
        }

        function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

        // after admin maintenance refresh, also show popup if active
        const origRefreshAdminMaintenance = refreshAdminMaintenance;
        async function refreshAdminMaintenanceWithPopup() {
          await origRefreshAdminMaintenance();
          try {
            const data = await api('/api/maintenance');
            const list = data?.maintenance || [];
            const now = new Date();
            const active = (list || []).filter(m => {
              if (!m) return false;
              if (typeof m.active !== 'undefined' && Number(m.active) === 0) return false;
              if (m.start_time || m.end_time) {
                const start = m.start_time ? new Date(m.start_time) : null;
                const end = m.end_time ? new Date(m.end_time) : null;
                if (start && now < start) return false;
                if (end && now > end) return false;
              }
              return true;
            });
            if (active.length) showMaintPopupAdmin(active);
          } catch (e) { /* ignore */ }
        }
        // replace initial call
        try { refreshAdminMaintenanceWithPopup().catch(()=>{}); } catch(e) {}

        // Wire maintenance-related buttons after DOM is ready
        const _btnRefreshMaint = document.getElementById('btnRefreshMaint');
        if (_btnRefreshMaint) _btnRefreshMaint.addEventListener('click', () => refreshAdminMaintenance());
        const _btnCreateMaintenance = document.getElementById('btnCreateMaintenance');
        if (_btnCreateMaintenance) _btnCreateMaintenance.addEventListener('click', () => performCreateOrUpdate());
        const _btnCancelEdit = document.getElementById('btnCancelEdit');
        if (_btnCancelEdit) _btnCancelEdit.addEventListener('click', () => clearForm());
    });

    // Fetch current admin settings (filter_bad_words)
    async function fetchSettingsAdmin() {
        const statusEl = document.getElementById('admin-filter-status');
        const btn = document.getElementById('admin-filter-toggle');
        const refreshBtn = document.getElementById('admin-refresh-words');
        try {
          const data = await api('/api/admin/settings');
          const val = data && (data.filter_bad_words === true || data.filter_bad_words === '1' || data.filter_bad_words === 1);
          if (statusEl) statusEl.textContent = val ? '敏感词过滤：已开启' : '敏感词过滤：已关闭';
          if (btn) btn.textContent = val ? '关闭' : '开启';
          if (btn) btn.disabled = false;
          if (refreshBtn) refreshBtn.disabled = false;
        } catch (err) {
          if (statusEl) statusEl.textContent = '敏感词过滤：读取失败';
          if (btn) btn.disabled = true;
          if (refreshBtn) refreshBtn.disabled = true;
          console.error('fetchSettingsAdmin error', err);
        }
    }

    // Toggle the filter_bad_words setting via admin API
    async function toggleFilter() {
      const btn = document.getElementById('admin-filter-toggle');
      if (!btn) return;
      btn.disabled = true;
      try {
        // read current
        const cur = await api('/api/admin/settings');
        const on = !!(cur && (cur.filter_bad_words === true || cur.filter_bad_words === '1' || cur.filter_bad_words === 1));
        await api('/api/admin/settings', { method: 'PUT', body: JSON.stringify({ filter_bad_words: !on }) });
        try { if (window.showSmallPopup) window.showSmallPopup('设置已更新', { type: 'success', duration: 2000 }); } catch(e) {}
        await fetchSettingsAdmin();
      } catch (err) {
        try { if (window.showSmallPopup) window.showSmallPopup(err.message || String(err), { type: 'error', duration: 3000 }); } catch(e) { console.error(err); }
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    // Admin action: force refresh of bad-word cache on this worker instance
    async function refreshWords() {
      const btn = document.getElementById('admin-refresh-words');
      if (!btn) return;
      btn.disabled = true;
      try {
        await api('/api/admin/refresh_words', { method: 'POST' });
        try { if (window.showSmallPopup) window.showSmallPopup('已刷新词库缓存', { type: 'success', duration: 2000 }); } catch (e) {}
      } catch (err) {
        try { if (window.showSmallPopup) window.showSmallPopup(err.message || String(err), { type: 'error', duration: 3000 }); } catch (e) { console.error(err); }
      } finally {
        btn.disabled = false;
      }
    }

    // --- Maintenance admin functions ---
    let currentEditingId = null;
    function toInputDatetime(s) {
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d)) return s;
      return d.toISOString().slice(0,16);
    }
    function clearForm() {
      document.getElementById('mTitle').value = '';
      document.getElementById('mDetails').value = '';
      document.getElementById('mStart').value = '';
      document.getElementById('mEnd').value = '';
      document.getElementById('mActive').checked = true;
      currentEditingId = null;
      document.getElementById('btnCancelEdit').style.display = 'none';
      document.getElementById('btnCreateMaintenance').textContent = '创建维护公告';
    }
    async function refreshAdminMaintenance() {
      const el = document.getElementById('admin-maintenance-list');
      try {
        const data = await api('/api/maintenance');
        const list = data?.maintenance || [];
        if (!Array.isArray(list) || list.length === 0) { el.textContent = '无计划维护/临时 issue'; return; }
        const html = list.map(m => `
          <div style="padding:8px;border-radius:8px;background:#f8fafc;margin-bottom:8px;display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
            <div style="flex:1">
              <strong>${m.title}</strong>
              <div class="muted-small" style="margin-top:4px">${m.start_time || ''} → ${m.end_time || ''}</div>
              <div style="margin-top:6px">${(m.details || '').slice(0,300)}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <div style="display:flex;gap:8px">
                <button class="btn btn-ghost admin-edit-maint" data-id="${m.id}">编辑</button>
                <button class="btn btn-danger admin-delete-maint" data-id="${m.id}">删除</button>
              </div>
              <div class="muted-small">id: ${m.id} • by ${m.created_by || '—'}</div>
            </div>
          </div>`).join('');
        el.innerHTML = html;
        // wire buttons
        document.querySelectorAll('.admin-delete-maint').forEach(b => b.addEventListener('click', async (ev) => {
          const id = Number(ev.currentTarget.getAttribute('data-id'));
          await deleteMaintenance(id);
        }));
        document.querySelectorAll('.admin-edit-maint').forEach(b => b.addEventListener('click', (ev) => {
          const id = Number(ev.currentTarget.getAttribute('data-id'));
          const item = list.find(x => Number(x.id) === id);
          if (item) beginEdit(item);
        }));
      } catch (e) { el.textContent = '无法读取公告：' + (e && e.message ? e.message : String(e)); }
    }
    async function performCreateOrUpdate() {
      const title = document.getElementById('mTitle').value || '';
      const details = document.getElementById('mDetails').value || '';
      const start = document.getElementById('mStart').value || null;
      const end = document.getElementById('mEnd').value || null;
      const active = document.getElementById('mActive').checked;
      if (!title) { try { if (window.showSmallPopup) window.showSmallPopup('请输入标题', { type: 'error', duration: 2000 }); } catch(e) {} return; }
      try {
        if (currentEditingId) {
          await api('/api/admin/maintenance', { method: 'PUT', body: JSON.stringify({ id: currentEditingId, title, details, start_time: start, end_time: end, active }) });
          try { if (window.showSmallPopup) window.showSmallPopup('更新成功', { type: 'success', duration: 2000 }); } catch(e) {}
          clearForm();
          await refreshAdminMaintenance();
        } else {
          await api('/api/admin/maintenance', { method: 'POST', body: JSON.stringify({ title, details, start_time: start, end_time: end, active }) });
          try { if (window.showSmallPopup) window.showSmallPopup('创建成功', { type: 'success', duration: 2000 }); } catch(e) {}
          await refreshAdminMaintenance();
        }
      } catch (e) { try { if (window.showSmallPopup) window.showSmallPopup((e && e.message) ? e.message : String(e), { type: 'error', duration: 3000 }); } catch(e2) { console.error(e); } }
    }
    async function deleteMaintenance(id) {
      if (!ADMIN_TOKEN) { try { if (window.showSmallPopup) window.showSmallPopup('需要管理员 token', { type: 'error', duration: 2000 }); } catch(e) {} return; }
      if (!confirm('确认删除 id=' + id + ' 的维护公告？')) return;
      try {
        await api('/api/admin/maintenance', { method: 'DELETE', body: JSON.stringify({ id }) });
        try { if (window.showSmallPopup) window.showSmallPopup('删除成功', { type: 'success', duration: 2000 }); } catch(e) {}
        await refreshAdminMaintenance();
      } catch (e) { try { if (window.showSmallPopup) window.showSmallPopup((e && e.message) ? e.message : String(e), { type: 'error', duration: 3000 }); } catch(e2) { console.error(e); } }
    }
    function beginEdit(m) {
      currentEditingId = m.id;
      document.getElementById('mTitle').value = m.title || '';
      document.getElementById('mDetails').value = m.details || '';
      document.getElementById('mStart').value = toInputDatetime(m.start_time);
      document.getElementById('mEnd').value = toInputDatetime(m.end_time);
      document.getElementById('mActive').checked = !!m.active;
      document.getElementById('btnCancelEdit').style.display = 'inline-block';
      document.getElementById('btnCreateMaintenance').textContent = '保存修改';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    

    let visitsOffset = 0;
    const VISITS_PAGE = 10;
    async function loadVisits() {
      const qInput = document.getElementById('visits-q');
      const q = qInput ? qInput.value.trim() : '';
      const params = new URLSearchParams();
      params.set('limit', String(VISITS_PAGE));
      params.set('offset', String(visitsOffset));
      if (q) params.set('q', q);
      const data = await api(`/api/admin/visits?${params.toString()}`);
      const tbody = document.querySelector('#visits tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      for (const v of data.visits) {
        const tr = document.createElement('tr');
        const uaShort = (v.ua || '').slice(0, 60);
        tr.innerHTML = `
          <td>${v.id}</td>
          <td class="muted">${v.time || ''}</td>
          <td>${v.username || ''}</td>
          <td>${v.page || ''}</td>
          <td class="muted">${v.title || ''}</td>
          <td class="muted">${v.referrer || ''}</td>
          <td class="muted" title="${(v.ua||'').replace(/"/g,'&quot;')}">${uaShort}${(v.ua||'').length>60?'…':''}</td>
        `;
        // add export button cell if visit has page referring to anon room
        const exportCell = document.createElement('td');
        if (v.page && v.page.includes('room_id=')) {
          const params = new URLSearchParams(v.page.split('?')[1] || '');
          const roomId = params.get('room_id');
          if (roomId) {
            const exportBtn = document.createElement('button');
            exportBtn.textContent = '导出会话';
            exportBtn.onclick = async () => {
              try {
                const data = await api(`/api/admin/export_chat?room_id=${encodeURIComponent(roomId)}`);
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat_${roomId}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
              } catch (err) { try { if (window.showSmallPopup) window.showSmallPopup(err.message || String(err), { type: 'error', duration: 3000 }); else console.log(err.message||err); } catch(e) { console.log(err.message||err); } }
            };
            exportCell.appendChild(exportBtn);
          }
        }
        tr.appendChild(exportCell);
        tbody.appendChild(tr);
      }
      // update pagination controls
      const controls = document.getElementById('visits-pager');
      if (controls) {
        controls.querySelector('#visits-prev').disabled = visitsOffset === 0;
        controls.querySelector('#visits-next').disabled = (data.visits || []).length < VISITS_PAGE;
      }
    }

    function visitsPrev() {
      visitsOffset = Math.max(0, visitsOffset - VISITS_PAGE);
      loadVisits();
    }
    function visitsNext() {
      visitsOffset = visitsOffset + VISITS_PAGE;
      loadVisits();
    }

    // simple pagination state for reports and audit
    window.reportsOffset = 0;
    const REPORTS_PAGE = 200;
    function reportsPrev() { window.reportsOffset = Math.max(0, window.reportsOffset - REPORTS_PAGE); loadReports(); }
    function reportsNext() { window.reportsOffset = window.reportsOffset + REPORTS_PAGE; loadReports(); }

    window.auditOffset = 0;
    const AUDIT_PAGE = 200;
    function auditPrev() { window.auditOffset = Math.max(0, window.auditOffset - AUDIT_PAGE); loadAudit(); }
    function auditNext() { window.auditOffset = window.auditOffset + AUDIT_PAGE; loadAudit(); }

    async function loadReports() {
      const q = '';
      const params = new URLSearchParams();
      params.set('limit', String(REPORTS_PAGE));
      params.set('offset', String(window.reportsOffset || 0));
      const data = await api('/api/admin/reports?' + params.toString());
      const tbody = document.querySelector('#reports tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      for (const r of data.reports) {
        const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.id}</td>
            <td class="muted">${r.time || ''}</td>
            <td>${r.reporter || ''}</td>
            <td>${r.target_username || r.target_room_id || ''}</td>
            <td class="muted">${r.reason || ''}</td>
            <td class="muted">${r.details || ''}</td>
            <td class="row-actions"></td>
          `;
        const actions = tr.querySelector('.row-actions');
        const resolveBtn = document.createElement('button');
        resolveBtn.textContent = '标记已处理';
        resolveBtn.onclick = async () => { await resolveReport(r.id, 'resolve'); };
        const disableBtn = document.createElement('button');
        disableBtn.textContent = '禁用用户';
        disableBtn.onclick = async () => { 
          try {
            let ok = false;
            ok = await showModalConfirm('确认禁用该用户？');
            if (!ok) return;
            await resolveReport(r.id, 'disable');
          } catch (e) { /* ignore */ }
        };
        const forceBtn = document.createElement('button');
        forceBtn.textContent = '强制结束会话';
        forceBtn.onclick = async () => { 
          try {
            let ok = false;
            ok = await showModalConfirm('确认强制结束该会话？');
            if (!ok) return;
            await resolveReport(r.id, 'force_end');
          } catch (e) { /* ignore */ }
        };
        actions.append(resolveBtn, disableBtn, forceBtn);
        // If details contains a JSON with bbs_id, fetch and show the message content and provide delete button
        try {
          const details = typeof r.details === 'string' ? JSON.parse(r.details) : r.details;
          const bbsId = details && details.bbs_id ? details.bbs_id : null;
          if (bbsId) {
            const viewBtn = document.createElement('button');
            viewBtn.textContent = '查看留言';
            viewBtn.onclick = async () => {
              try {
                const m = await api(`/api/admin/bbs?id=${encodeURIComponent(bbsId)}`);
                try { if (window.showSmallPopup) window.showSmallPopup('留言内容：\n' + (m.message?.content || '(空)'), { type: 'success', duration: 4000 }); else console.log('留言内容：\n' + (m.message?.content || '(空)')); } catch(e) { console.log('留言内容：\n' + (m.message?.content || '(空)')); }
              } catch (err) { try { if (window.showSmallPopup) window.showSmallPopup(err.message || String(err), { type: 'error', duration: 3000 }); else console.log(err.message||err); } catch(e) { console.log(err.message||err); } }
            };
            const delBtn = document.createElement('button');
            delBtn.textContent = '删除留言';
            delBtn.onclick = async () => {
              try {
                let ok = false;
                ok = await showModalConfirm('确认删除该留言？');
                if (!ok) return;
                await api('/api/admin/bbs', { method: 'DELETE', body: JSON.stringify({ id: Number(bbsId) }) });
                try { if (window.showSmallPopup) window.showSmallPopup('已删除', { type: 'success', duration: 2500 }); else console.log('已删除'); } catch(e) { console.log('已删除'); }
                loadReports().catch(()=>{});
              } catch (err) { try { if (window.showSmallPopup) window.showSmallPopup(err.message || String(err), { type: 'error', duration: 3000 }); else console.log(err.message || String(err)); } catch(e) { console.log(err.message || String(err)); } }
            };
            actions.append(viewBtn, delBtn);
          }
        } catch (e) { /* ignore parse errors */ }
        tbody.appendChild(tr);
      }
      // pagination controls for reports (append or show existing)
      const repPager = document.getElementById('reports-pager');
      if (repPager) {
          repPager.querySelector('#reports-prev').disabled = (typeof window.reportsOffset === 'undefined' ? 0 : window.reportsOffset) === 0;
          repPager.querySelector('#reports-next').disabled = window.reportsOffset + REPORTS_PAGE >= (data.total || (data.reports||[]).length);
          const pageSpan = repPager.querySelector('#reports-page');
          if (pageSpan) pageSpan.textContent = `${Math.floor(window.reportsOffset/REPORTS_PAGE)+1} / ${Math.max(1, Math.ceil((data.total||0)/REPORTS_PAGE))}`;
      }
    }

    async function resolveReport(reportId, action) {
      try {
        await api('/api/admin/resolve_report', { method: 'POST', body: JSON.stringify({ report_id: reportId, action }) });
  try { if (window.showSmallPopup) window.showSmallPopup('已处理', { type: 'success', duration: 2500 }); else console.log('已处理'); } catch(e) { console.log('已处理'); }
        loadReports().catch(()=>{});
        loadUsers().catch(()=>{});
  } catch (err) { try { if (window.showSmallPopup) window.showSmallPopup(err.message || String(err), { type: 'error', duration: 3000 }); else console.log(err.message || String(err)); } catch(e) { console.log(err.message || String(err)); } }
    }

    async function loadAnalytics() {
      const el = document.getElementById('analytics');
      const srcEl = document.getElementById('analytics-source');
      if (!el) return;
      try {
        const data = await api('/api/admin/analytics');
        const src = data.analytics_source || 'unknown';
        const human = src === 'analytics_engine' ? 'Analytics Engine' : (src === 'cloudflare_graphql' ? 'Cloudflare GraphQL' : (src === 'db' ? 'DB' : src));
        if (srcEl) srcEl.textContent = `来源: ${human}`;
        el.innerHTML = `<div>近30日访问数目（按日）: ${JSON.stringify(data.visits || [])}</div><div>24小时内活跃用户数: ${data.active_users_last_24h || 0}</div>`;
      } catch (err) {
        const msg = (err && err.message) ? String(err.message) : String(err);
        if (srcEl) srcEl.textContent = `错误`;
        el.innerHTML = `<div style="color:#c00">统计数据获取失败：${msg}</div>`;
        console.error('loadAnalytics error:', err);
      }
    }

    // Admin diagnostic: test Bigmodel connectivity from the worker
    async function runAiTest() {
      const outEl = document.getElementById('ai-test-output');
      outEl.textContent = '运行中...';
      try {
        const prompt = document.getElementById('ai-prompt').value || '测试 Bigmodel 连接';
        const model = document.getElementById('ai-model').value || 'glm-4';
        const temperature = parseFloat(document.getElementById('ai-temp').value) || 0.7;
        const data = await api('/api/admin/ai_test', { method: 'POST', body: JSON.stringify({ prompt, model, temperature }) });
        // api() returns data.data from the worker's jsonResponse, so display it nicely
        outEl.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        const msg = (err && err.message) ? String(err.message) : String(err);
        outEl.textContent = `调用失败：${msg}`;
        console.error('runAiTest error:', err);
      }
    }

    async function loadAudit() {
      const params = new URLSearchParams();
      params.set('limit', String(AUDIT_PAGE));
      params.set('offset', String(window.auditOffset || 0));
      const data = await api('/api/admin/audit?' + params.toString());
      const el = document.getElementById('audit');
      if (!el) return;
      el.innerHTML = '<pre>' + JSON.stringify(data.audits || [], null, 2) + '</pre>';
      const pager = document.getElementById('audit-pager');
      if (pager) {
        pager.querySelector('button:nth-child(1)').disabled = (window.auditOffset || 0) === 0;
        pager.querySelector('button:nth-child(2)').disabled = (window.auditOffset || 0) + AUDIT_PAGE >= (data.total || (data.audits||[]).length);
        const span = document.getElementById('audit-page');
        if (span) span.textContent = `${Math.floor((window.auditOffset||0)/AUDIT_PAGE)+1} / ${Math.max(1, Math.ceil((data.total||0)/AUDIT_PAGE))}`;
      }
    }
  </script>
</head>
<body>
  <header>
    <label>Admin Token: <input id="token" type="password" placeholder="输入后台口令" style="width:260px"></label>
    <button onclick="saveToken()">保存并加载</button>
    <span id="admin-filter-status" class="muted" style="margin-left:12px;">敏感词过滤：未加载</span>
    <button id="admin-filter-toggle" style="margin-left:6px;" onclick="toggleFilter()" disabled>切换</button>
    <button id="admin-refresh-words" style="margin-left:6px;" onclick="refreshWords()" disabled>刷新词库缓存</button>
    <input id="q" placeholder="搜索用户名" onkeydown="if(event.key==='Enter') loadUsers()" />
    <button onclick="loadUsers()">搜索/刷新</button>
  </header>

  <section>
    <h3>用户列表</h3>
    <table id="users">
      <thead>
        <tr>
          <th>用户名</th><th>兴趣</th><th>性别</th><th>心情</th><th>最后心情日期</th><th>聊天中</th><th>状态</th><th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
  <section style="margin-top:20px;">
    <h3>Diagnose: Bigmodel 连接测试</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
      <label style="display:flex;flex-direction:column;">Prompt<textarea id="ai-prompt" rows="2" style="width:420px">测试 Bigmodel 连接</textarea></label>
      <label>Model<input id="ai-model" value="glm-4" style="width:120px"></label>
      <label>Temp<input id="ai-temp" value="0.7" style="width:60px"></label>
      <button onclick="runAiTest()">Run</button>
    </div>
    <pre id="ai-test-output" style="background:#f5f5f5;padding:8px;border-radius:6px;max-height:240px;overflow:auto;white-space:pre-wrap;"></pre>
    <p class="muted">说明：此接口会在 Worker 端使用配置的 BIGMODEL_API_KEY 进行调用。该页面需要正确填写 Admin Token（保存后会传到请求头）。不会在页面中显示或泄露 API Key。</p>
  </section>
    <div id="users-pager" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
      <button id="users-prev" onclick="usersPrev()">上一页</button>
      <button id="users-next" onclick="usersNext()">下一页</button>
      <span id="users-page" class="muted" style="margin-left:8px;">1 / 1</span>
    </div>

  <section style="margin-top:20px;">
    <h3>追加敏感词（临时）</h3>
    <textarea id="words" rows="6" style="width:100%;" placeholder="每行一个词"></textarea>
    <div>
      <button onclick="appendWords()">追加</button>
    </div>
    <p class="muted">说明：这里将词条写入 KV 的 bad_words_append，后续请用构建脚本合并到主词库并更新索引。</p>
  </section>

  <section style="margin-top:20px;">
    <h3>维护公告管理（Admin）</h3>
    <div id="admin-maintenance-list" class="muted-small">加载中…</div>
    <div style="display:flex;gap:8px;flex-direction:column;max-width:720px;margin-top:8px">
      <input id="mTitle" placeholder="标题 (必填)" style="padding:8px;border-radius:8px;border:1px solid #e6eefc">
      <textarea id="mDetails" placeholder="详细描述" style="padding:8px;border-radius:8px;border:1px solid #e6eefc"></textarea>
      <div style="display:flex;gap:8px">
        <input id="mStart" type="datetime-local"> <input id="mEnd" type="datetime-local"> <label style="display:inline-flex;align-items:center;gap:6px"><input id="mActive" type="checkbox" checked> 生效</label>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnCreateMaintenance" class="btn btn-primary">创建维护公告</button>
        <button id="btnCancelEdit" class="btn btn-ghost" style="display:none">取消编辑</button>
        <button id="btnRefreshMaint" class="btn btn-ghost">刷新公告列表</button>
      </div>
    </div>
  </section>

  <section style="margin-top:20px;">
    <h3>访问日志</h3>
    <div style="margin-bottom:8px;">
      <input id="visits-q" placeholder="按用户名/页面/标题搜索" onkeydown="if(event.key==='Enter') loadVisits()" />
      <button onclick="loadVisits()">刷新</button>
    </div>
    <table id="visits">
      <thead>
        <tr>
          <th>ID</th><th>时间</th><th>用户名</th><th>页面</th><th>标题</th><th>来源</th><th>UA</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="visits-pager" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
      <button id="visits-prev" onclick="visitsPrev()">上一页</button>
      <button id="visits-next" onclick="visitsNext()">下一页</button>
      <span class="muted" style="margin-left:8px;">每页 ${'10'} 条</span>
    </div>
  </section>
  <section style="margin-top:20px;">
    <h3>举报列表</h3>
    <div style="margin-bottom:8px;">
      <button onclick="loadReports()">刷新举报</button>
    </div>
    <table id="reports">
      <thead><tr><th>ID</th><th>时间</th><th>举报人</th><th>目标</th><th>理由</th><th>详情</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="reports-pager" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
      <button id="reports-prev" onclick="reportsPrev()">上一页</button>
      <button id="reports-next" onclick="reportsNext()">下一页</button>
      <span id="reports-page" class="muted" style="margin-left:8px;">1 / 1</span>
    </div>
  </section>

  <section style="margin-top:20px;">
    <h3>Analytics <span id="analytics-source" class="muted" style="margin-left:8px;font-size:13px;"></span></h3>
    <div id="analytics">(loading...)</div>
    <div><button onclick="loadAnalytics()">刷新统计</button></div>
  </section>
  <section style="margin-top:20px;">
    <h3>Admin Audit Log</h3>
    <div id="audit">(loading...)</div>
    <div><button onclick="loadAudit()">刷新审计</button></div>
  </section>
  <div id="audit-pager" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
    <button onclick="auditPrev()">上一页</button>
    <button onclick="auditNext()">下一页</button>
    <span id="audit-page" class="muted" style="margin-left:8px;">1 / 1</span>
  </div>
  <script src="./tracker.js"></script>
  <!-- maintenance popup placeholder (admin pages also show to staff) -->
  <div id="maint-popup" style="display:none;position:fixed;top:18px;right:18px;max-width:360px;background:#fff;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);padding:12px 14px;z-index:1200">
    <button class="close" aria-label="关闭" style="position:absolute;top:6px;right:8px;border:none;background:transparent;cursor:pointer">✕</button>
    <div id="maint-popup-body"></div>
  </div>
  
  <!-- BBS modal -->
  <div id="bbs-modal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:16px;max-width:700px;margin:auto;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.2);">
      <h4>留言详情</h4>
      <div id="bbs-modal-body" style="white-space:pre-wrap;margin-bottom:12px;color:#111"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="bbs-delete-btn">删除留言</button>
        <button id="bbs-close-btn">关闭</button>
      </div>
    </div>
  </div>
  <script>
    let currentBbsId = null;
    async function openBbsModal(id) {
      currentBbsId = id;
      const el = document.getElementById('bbs-modal');
      const body = document.getElementById('bbs-modal-body');
      try {
        const data = await api(`/api/admin/bbs?id=${encodeURIComponent(id)}`);
        const m = data.message || {};
        body.textContent = `ID: ${m.id}\n昵称: ${m.nickname || ''}\n时间: ${m.time || ''}\n心情: ${m.mood || ''}\n\n内容:\n${m.content || ''}`;
      } catch (err) {
        body.textContent = '错误：无法获取留言';
      }
      el.style.display = 'flex';
    }
    function closeBbsModal() { document.getElementById('bbs-modal').style.display = 'none'; currentBbsId = null; }
    document.getElementById('bbs-close-btn').onclick = closeBbsModal;
    document.getElementById('bbs-delete-btn').onclick = async () => {
      if (!currentBbsId) return;
      try {
        const ok = await showModalConfirm('确定删除这条留言？删除后会记录到审计日志。');
        if (!ok) return;
        await api('/api/admin/bbs', { method: 'DELETE', body: JSON.stringify({ id: Number(currentBbsId) }) });
  try { if (window.showSmallPopup) window.showSmallPopup('已删除', { type: 'success', duration: 2500 }); else console.log('已删除'); } catch(e) { console.log('已删除'); }
        closeBbsModal();
        loadReports().catch(()=>{});
        loadUsers().catch(()=>{});
  } catch (err) { try { if (window.showSmallPopup) window.showSmallPopup(err.message || String(err), { type: 'error', duration: 3000 }); else console.log(err.message || err); } catch(e) { console.log(err.message || err); } }
    };
  </script>
</body>
</html>